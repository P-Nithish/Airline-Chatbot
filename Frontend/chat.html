<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AirBot • Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    .chat-wrap{max-width:760px;margin:4vh auto;background:#0b1222;border:1px solid #22304f;border-radius:16px;overflow:hidden}
    .chat-head{padding:12px 16px;background:#0d1730;color:#e5e7eb;font-weight:600}
    .chat-body{padding:16px;height:60vh;overflow:auto;background:#0a1327}
    .msg{max-width:75%;margin:8px 0;padding:10px 12px;border-radius:12px;color:#e5e7eb}
    .msg.user{margin-left:auto;background:#1e3a8a}
    .msg.bot{margin-right:auto;background:#111827}
    .chat-foot{display:flex;gap:8px;padding:12px;background:#0d1730}
    .chat-foot input{flex:1;padding:10px;border-radius:10px;border:1px solid #22304f;background:#0a1327;color:#e5e7eb}
    .chat-foot button{padding:10px 14px;border:none;border-radius:10px;background:#3b82f6;color:#fff;cursor:pointer}
    .ticket{padding:10px;border:1px solid #22304f;border-radius:10px;margin:8px 0;background:#0b1222}
    .ticket h4{margin:0 0 6px}
    .ticket button{margin-top:6px}
  </style>
</head>
<body>
  <div class="chat-wrap">
    <div class="chat-head">AirBot Assistant</div>
    <div id="chat" class="chat-body"></div>
    <div class="chat-foot">
      <input id="input" placeholder="Type here… (e.g., Cancel Trip)" />
      <button id="send">Send</button>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
  const API_BASE = "http://127.0.0.1:8000";
  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");

  const seatFlow = {
    active: false,
    step: null,      
    data: { pnr:"", flight_id:"", src:"", dst:"", airline_name:"" }
  };

  function addMsg(text, who="bot"){
    const m = document.createElement("div");
    m.className = "msg " + (who==="user"?"user":"bot");
    m.innerHTML = text;
    chat.appendChild(m);
    chat.scrollTop = chat.scrollHeight;
  }

  function seatCard(s){
    const d = document.createElement("div");
    d.className = "ticket";
    d.innerHTML = `
      <h4>${s.airline_name || ""} ${s.flight_id || ""} • ${s.src || ""} → ${s.dst || ""}</h4>
      <div>${s.dep_time || ""} → ${s.arr_time || ""}</div>
      <div>Seat: <b>${s.seat_no || "-"}</b> • Status: <b>${s.Seat_status || "-"}</b></div>
      <div>PNR: ${s.pnr || "-"}</div>
    `;
    return d;
  }

  const statusFlow = {
    active: false,
    step: null,   // 'pnr' -> 'flight_id' -> 'src' -> 'dst' -> 'airline_name' -> 'done'
    data: { pnr:"", flight_id:"", src:"", dst:"", airline_name:"" }
  };

  function statusCard(s, source){
    const d = document.createElement("div");
    d.className = "ticket";
    const header = `${s.airline_name || ""} ${s.flight_id || ""}`.trim();
    d.innerHTML = `
      <h4>${header || "Flight"} • ${s.src || ""} → ${s.dst || ""}</h4>
      <div>${s.dep_time || ""} → ${s.arr_time || ""}</div>
      <div>Current: <b>${s.current_status || "Unknown"}</b>
      ${s.current_departure ? ` • Departs at: ${s.current_departure}` : ""}
      ${s.current_arrival ? ` • Arrives at: ${s.current_arrival}` : ""}</div>
      ${s.pnr ? `<div>PNR: ${s.pnr}</div>` : ""}
      ${s.seat_no ? `<div>Seat: ${s.seat_no} ${s.Seat_status ? `(${s.Seat_status})` : ""}</div>` : ""}
      <div style="opacity:.7;margin-top:6px;">Source: ${source}</div>
    `;
    return d;
  }

  async function callFlightStatusAPI(payload){
    const res = await fetch(`${API_BASE}/chat/flight-status/`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok){
      addMsg(data.message || data.error || "Please provide at least one field.", "bot");
      return;
    }

    const booked = (data.from_tickets && data.from_tickets.items) || [];
    const inventory = (data.from_available_tickets && data.from_available_tickets.items) || [];
    const total = (data.from_tickets?.count || 0) + (data.from_available_tickets?.count || 0);

    if (!total){
      addMsg("No matching flights found.", "bot");
      return;
    }

    addMsg(`Found <b>${total}</b> matching record${total>1?"s":""}.`, "bot");

    if (booked.length){
      addMsg("<i>From your booked tickets:</i>", "bot");
      booked.forEach(x => chat.appendChild(statusCard(x, "tickets")));
    }
    if (inventory.length){
      addMsg("<i>From available inventory:</i>", "bot");
      inventory.forEach(x => chat.appendChild(statusCard(x, "available_tickets")));
    }
    chat.scrollTop = chat.scrollHeight;
  }


  async function callSeatAPI(payload){
    const res = await fetch(`${API_BASE}/chat/seat-availability/`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok){
      addMsg(data.message || data.error || "Please provide at least one field.", "bot");
      return;
    }
    if(!data.count){
      addMsg("No matching available seats found.", "bot");
      return;
    }
    addMsg(`Found <b>${data.count}</b> available seat${data.count>1?"s":""}:`, "bot");
    (data.seats || []).forEach(s => chat.appendChild(seatCard(s)));
    chat.scrollTop = chat.scrollHeight;
  }

    const API_BASE = "http://127.0.0.1:8000";
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");

    function toast(msg, type="info", t=2500){
      const cont = document.getElementById("toast-container");
      const el = document.createElement("div");
      el.className = "toast " + (type==="success"?"success":type==="error"?"error":"info");
      el.textContent = msg;
      cont.appendChild(el);
      setTimeout(()=>el.remove(), t);
    }

    function addMsg(text, who="bot"){
      const m = document.createElement("div");
      m.className = "msg " + (who==="user"?"user":"bot");
      m.innerHTML = text;
      chat.appendChild(m);
      chat.scrollTop = chat.scrollHeight;
    }

      function startStatusFlow(){
    statusFlow.active = true;
    statusFlow.step = "pnr";
    statusFlow.data = { pnr:"", flight_id:"", src:"", dst:"", airline_name:"" };
    addMsg(`To check flight status, you can provide any of:<br>
      <code>{ "pnr": &lt;string&gt;, "flight_id": &lt;string&gt;, "src": &lt;string&gt;, "dst": &lt;string&gt;, "airline_name": &lt;string&gt; }</code><br>
      I’ll ask one by one — type your reply or <b>skip</b>.`, "bot");
    addMsg("PNR? (e.g., RWQ248) • or <b>skip</b>", "bot");
  }

  function proceedStatusFlow(userText){
    const val = userText.trim();
    const lower = val.toLowerCase();

    if (lower === "exit"){
      statusFlow.active = false;
      statusFlow.step = null;
      addMsg("Flight status flow cancelled.", "bot");
      return;
    }

    switch(statusFlow.step){
      case "pnr":
        if (lower !== "skip") statusFlow.data.pnr = val.toUpperCase();
        statusFlow.step = "flight_id";
        addMsg("Flight ID? (e.g., LH0109) • or <b>skip</b>", "bot");
        break;

      case "flight_id":
        if (lower !== "skip") statusFlow.data.flight_id = val.toUpperCase();
        statusFlow.step = "src";
        addMsg("Source airport (IATA)? (e.g., ATL) • or <b>skip</b>", "bot");
        break;

      case "src":
        if (lower !== "skip") statusFlow.data.src = val.toUpperCase();
        statusFlow.step = "dst";
        addMsg("Destination airport (IATA)? (e.g., MIA) • or <b>skip</b>", "bot");
        break;

      case "dst":
        if (lower !== "skip") statusFlow.data.dst = val.toUpperCase();
        statusFlow.step = "airline_name";
        addMsg("Airline name? (e.g., Lufthansa) • or <b>skip</b>", "bot");
        break;

      case "airline_name":
        if (lower !== "skip") statusFlow.data.airline_name = val;
        statusFlow.step = "done";
        const payload = {};
        Object.entries(statusFlow.data).forEach(([k,v]) => { if (v) payload[k]=v; });

        if (Object.keys(payload).length === 0){
          addMsg("Please provide at least one field. Type <b>Flight Status</b> to restart.", "bot");
          statusFlow.active = false;
          statusFlow.step = null;
          return;
        }

        addMsg("Checking flight status…", "bot");
        statusFlow.active = false;
        statusFlow.step = null;
        callFlightStatusAPI(payload);
        break;
    }
  }

    function handleUserMessage(text){
    addMsg(text, "user");
    const low = text.trim().toLowerCase();

    if (statusFlow.active) return proceedStatusFlow(text);
    if (seatFlow.active)   return proceedSeatFlow(text); 

    if (low.includes("flight status") || low === "status" || low === "flight") {
      startStatusFlow();
      return;
    }

    if (low.includes("seat availability") || low.includes("availability") || low === "seat") {
      startSeatFlow();  
      return;
    }

    if (low.includes("cancel")) {
      addMsg("Fetching your booked tickets…", "bot");
      fetchTickets();
      return;
    }

    addMsg('Try: <b>Flight Status</b>, <b>Seat Availability</b>, or <b>Cancel Trip</b>.', "bot");
  }



    function ticketCard(t){
      const div = document.createElement("div");
      div.className = "ticket";
      div.innerHTML = `
        <h4>${t.flight_no} • ${t.src} → ${t.dst} • Seat ${t.seat_no}</h4>
        <div>${t.flight_date} • ${t.dep_time} → ${t.arr_time}</div>
        <div>Price: ₹${t.price}</div>
        <button class="btn-cancel">Cancel this ticket</button>
      `;
      div.querySelector(".btn-cancel").addEventListener("click", async ()=>{
        const user_id = localStorage.getItem("user_id");
        const body = { user_id, flight_id: t.flight_id, seat_no: t.seat_no };
        const res = await fetch(`${API_BASE}/chat/cancel/`,{
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(body)
        });
        const data = await res.json().catch(()=> ({}));
        if(res.ok){
          toast("Ticket cancelled. Refund ₹"+data.refund_amount, "success");
          addMsg(`Cancelled ${t.flight_no} seat ${t.seat_no}. Refund ₹${data.refund_amount}.`, "bot");
        }else{
          toast(data.error || "Cancel failed", "error");
        }
      });
      return div;
    }

    async function fetchTickets(){
      const user_id = localStorage.getItem("user_id");
      if(!user_id){ addMsg("Please sign in again.", "bot"); return; }
      const res = await fetch(`${API_BASE}/chat/my-tickets/?user_id=${encodeURIComponent(user_id)}`);
      const data = await res.json().catch(()=>({tickets:[]}));
      if(!res.ok){ addMsg("Couldn't fetch your tickets.", "bot"); return; }
      if(!data.tickets || data.tickets.length===0){
        addMsg("No active bookings found for your account.", "bot"); return;
      }
      addMsg("Select a ticket to cancel:", "bot");
      data.tickets.forEach(t => chat.appendChild(ticketCard(t)));
      chat.scrollTop = chat.scrollHeight;
    }

      function handleUserMessage(text){
    addMsg(text, "user");
    const low = text.trim().toLowerCase();

    if (seatFlow.active) {
      return proceedSeatFlow(text);
    }

    if (low.includes("seat availability") || low === "seat" || low.includes("availability")) {
      startSeatFlow();
      return;
    }

    if (low.includes("cancel")) {
      addMsg("Fetching your booked tickets…", "bot");
      fetchTickets();
      return;
    }

    addMsg('Try: <b>Seat Availability</b> or <b>Cancel Trip</b>.', "bot");
  }

    sendBtn.addEventListener("click", ()=> {
      const txt = input.value.trim(); if(!txt) return;
      input.value = ""; handleUserMessage(txt);
    });
    input.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ sendBtn.click(); }});

    addMsg("Hello! How may I assist you today?");

  </script>
</body>
</html>
