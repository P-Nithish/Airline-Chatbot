<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AirBot • Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="chat-wrap">
    <div class="chat-head">AirBot Assistant</div>
    <div id="chat" class="chat-body"></div>
    <div class="chat-foot">
      <input id="input" placeholder="Type here… (e.g., Cancel Trip, Cancellation Policy)" />
      <button id="send">Send</button>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>

  const API_BASE = "http://127.0.0.1:8000";
  const chat  = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");

  function addMsg(text, who = "bot", isHTML = true) {
    const m = document.createElement("div");
    m.className = "msg " + (who === "user" ? "user" : "bot");
    if (isHTML) m.innerHTML = text; else m.textContent = text;
    chat.appendChild(m);
    chat.scrollTop = chat.scrollHeight;
  }

  function toast(msg, type = "info", t = 2500) {
    const cont = document.getElementById("toast-container");
    const el = document.createElement("div");
    el.className = "toast " + (type === "success" ? "success" : type === "error" ? "error" : "info");
    el.textContent = msg;
    cont.appendChild(el);
    setTimeout(() => el.remove(), t);
  }

  // ---------- Seat Availability ----------
  const seatFlow = {
    active: false,
    step: null,
    data: { pnr:"", flight_id:"", src:"", dst:"", airline_name:"" }
  };

  function seatCard(s){
    const d = document.createElement("div");
    d.className = "ticket";
    d.innerHTML = `
      <h4>${s.airline_name || ""} ${s.flight_id || ""} • ${s.src || ""} → ${s.dst || ""}</h4>
      <div>${s.dep_time || ""} → ${s.arr_time || ""}</div>
      <div>Seat: <b>${s.seat_no || "-"}</b> • Status: <b>${s.Seat_status || "-"}</b></div>
      <div>PNR: ${s.pnr || "-"}</div>`;
    return d;
  }

  async function callSeatAPI(payload){
    const res = await fetch(`${API_BASE}/chat/seat-availability/`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok){ addMsg(data.message || data.error || "Please provide at least one field."); return; }
    if(!data.count){ addMsg("No matching available seats found."); return; }
    addMsg(`Found <b>${data.count}</b> available seat${data.count>1?"s":""}:`);
    (data.seats || []).forEach(s => chat.appendChild(seatCard(s)));
    chat.scrollTop = chat.scrollHeight;
  }

  function startSeatFlow(){
    seatFlow.active = true;
    seatFlow.step = "pnr";
    seatFlow.data = { pnr:"", flight_id:"", src:"", dst:"", airline_name:"" };
    addMsg(`To search seat availability, you can provide any of:<br>
      <code>{ "pnr": &lt;string&gt;, "flight_id": &lt;string&gt;, "src": &lt;string&gt;, "dst": &lt;string&gt;, "airline_name": &lt;string&gt; }</code><br>
      I’ll ask one by one — type your reply or <b>skip</b>.`);
    addMsg("PNR? (e.g., RWQ248) • or <b>skip</b>");
  }

  function proceedSeatFlow(userText){
    const val = userText.trim();
    const lower = val.toLowerCase();
    if (lower === "exit") { seatFlow.active=false; seatFlow.step=null; addMsg("Seat availability flow cancelled."); return; }

    switch(seatFlow.step){
      case "pnr":
        if (lower !== "skip") seatFlow.data.pnr = val.toUpperCase();
        seatFlow.step = "flight_id";
        addMsg("Flight ID? (e.g., LH0109) • or <b>skip</b>"); break;
      case "flight_id":
        if (lower !== "skip") seatFlow.data.flight_id = val.toUpperCase();
        seatFlow.step = "src";
        addMsg("Source (IATA)? (e.g., ATL) • or <b>skip</b>"); break;
      case "src":
        if (lower !== "skip") seatFlow.data.src = val.toUpperCase();
        seatFlow.step = "dst";
        addMsg("Destination (IATA)? (e.g., MIA) • or <b>skip</b>"); break;
      case "dst":
        if (lower !== "skip") seatFlow.data.dst = val.toUpperCase();
        seatFlow.step = "airline_name";
        addMsg("Airline? (e.g., Lufthansa) • or <b>skip</b>"); break;
      case "airline_name":
        if (lower !== "skip") seatFlow.data.airline_name = val;
        seatFlow.step = "done";
        const payload = {};
        Object.entries(seatFlow.data).forEach(([k,v]) => { if (v) payload[k]=v; });
        if (Object.keys(payload).length === 0){ addMsg("Please provide at least one field. Type <b>Seat Availability</b> to restart."); seatFlow.active=false; seatFlow.step=null; return; }
        addMsg("Searching available seats…");
        seatFlow.active = false; seatFlow.step = null;
        callSeatAPI(payload);
        break;
    }
  }

  // ---------- Flight Status ----------
  const statusFlow = {
    active: false,
    step: null,
    data: { pnr:"", flight_id:"", src:"", dst:"", airline_name:"" }
  };

  function statusCard(s, source){
    const d = document.createElement("div");
    d.className = "ticket";
    const header = `${s.airline_name || ""} ${s.flight_id || ""}`.trim();
    d.innerHTML = `
      <h4>${header || "Flight"} • ${s.src || ""} → ${s.dst || ""}</h4>
      <div>${s.dep_time || ""} → ${s.arr_time || ""}</div>
      <div>Current: <b>${s.current_status || "Unknown"}</b>
      ${s.current_departure ? ` • Departs at: ${s.current_departure}` : ""}
      ${s.current_arrival ? ` • Arrives at: ${s.current_arrival}` : ""}</div>
      ${s.pnr ? `<div>PNR: ${s.pnr}</div>` : ""}
      ${s.seat_no ? `<div>Seat: ${s.seat_no} ${s.Seat_status ? `(${s.Seat_status})` : ""}</div>` : ""}
      <div style="opacity:.7;margin-top:6px;">Source: ${source}</div>`;
    return d;
  }

  async function callFlightStatusAPI(payload){
    const res = await fetch(`${API_BASE}/chat/flight-status/`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok){ addMsg(data.message || data.error || "Please provide at least one field."); return; }

    const booked    = (data.from_tickets?.items) || [];
    const inventory = (data.from_available_tickets?.items) || [];
    const total = (data.from_tickets?.count || 0) + (data.from_available_tickets?.count || 0);

    if (!total){ addMsg("No matching flights found."); return; }

    addMsg(`Found <b>${total}</b> matching record${total>1?"s":""}.`);
    if (booked.length){ addMsg("<i>From your booked tickets:</i>"); booked.forEach(x => chat.appendChild(statusCard(x, "tickets"))); }
    if (inventory.length){ addMsg("<i>From available inventory:</i>"); inventory.forEach(x => chat.appendChild(statusCard(x, "available_tickets"))); }
    chat.scrollTop = chat.scrollHeight;
  }

  // ---- One-shot Flight Status flow ----
const statusInputFlow = { active: false };

function normalizeKey(k) {
  k = k.trim().toLowerCase();
  if (["pnr", "p.n.r"].includes(k)) return "pnr";
  if (["flight", "flight_id", "flightid", "fid"].includes(k)) return "flight_id";
  if (["src", "from", "origin"].includes(k)) return "src";
  if (["dst", "to", "dest", "destination"].includes(k)) return "dst";
  if (["airline", "airline_name", "carrier"].includes(k)) return "airline_name";
  return null;
}

function parseFlightFiltersLine(text) {
  const payload = {};
  text.split(/[,;]+/).forEach(part => {
    const p = part.trim();
    if (!p) return;
    const [rawK, rawV] = p.split(/[-:=]/, 2);     
    if (!rawV) return;
    const key = normalizeKey(rawK || "");
    if (!key) return;
    let val = (rawV || "").trim().replace(/^"|"$/g, "");

    if (["pnr", "flight_id", "src", "dst"].includes(key)) val = val.toUpperCase();
    payload[key] = val;
  });
  return payload;
}

function startStatusInputFlow() {
  statusInputFlow.active = true;
  addMsg(
    `Send flight details in one message using key-value pairs. Examples:<br>
     • <code>pnr-RWQ248</code><br>
     • <code>flight_id-LH0109</code><br>
     • <code>src-ATL, dst-MIA</code><br>
     • <code>src-ATL, dst-MIA, airline-Lufthansa</code><br>
     Use any subset of: <code>pnr</code>, <code>flight_id</code>, <code>src</code>, <code>dst</code>, <code>airline</code>.<br>
     Type <b>exit</b> to cancel.`,
    "bot"
  );
}

function proceedStatusInputFlow(userText) {
  const val = userText.trim();
  if (val.toLowerCase() === "exit") {
    statusInputFlow.active = false;
    addMsg("Flight status flow cancelled.", "bot");
    return;
  }

  const payload = parseFlightFiltersLine(val);
  if (Object.keys(payload).length === 0) {
    addMsg(
      `Couldn't read any details. Try e.g. <code>pnr-RWQ248</code> or <code>src-ATL, dst-MIA</code>.`,
      "bot"
    );
    return;
  }

  statusInputFlow.active = false;
  addMsg("Checking flight status…", "bot");
  callFlightStatusAPI(payload);
}

  
  // ---- One-shot Seat Availability flow ----
const seatInputFlow = { active: false };

function startSeatInputFlow() {
  seatInputFlow.active = true;
  addMsg(
    `Send seat search in one message using key-value pairs. Examples:<br>
     • <code>pnr-RWQ248</code><br>
     • <code>flight_id-LH0109</code><br>
     • <code>src-ATL, dst-MIA</code><br>
     • <code>src-ATL, dst-MIA, airline-Lufthansa</code><br>
     Use any subset of: <code>pnr</code>, <code>flight_id</code>, <code>src</code>, <code>dst</code>, <code>airline</code>.<br>
     Type <b>exit</b> to cancel.`,
    "bot"
  );
}

function proceedSeatInputFlow(userText) {
  const val = userText.trim();
  if (val.toLowerCase() === "exit") {
    seatInputFlow.active = false;
    addMsg("Seat availability flow cancelled.", "bot");
    return;
  }

  const payload = parseFlightFiltersLine(val);   
  if (Object.keys(payload).length === 0) {
    addMsg(
      `Couldn't read any details. Try e.g. <code>pnr-RWQ248</code> or <code>src-ATL, dst-MIA</code>.`,
      "bot"
    );
    return;
  }

  seatInputFlow.active = false;
  addMsg("Searching available seats…", "bot");
  callSeatAPI(payload);
}


  

  // ---------- Booked tickets (cancel) ----------
  function createTicketCard(t) {
    const div = document.createElement("div");
    div.className = "ticket";
    div.innerHTML = `
      <h4>${t.flight_id} • ${t.src} → ${t.dst} • Seat ${t.seat_no}</h4>
      <div>${new Date(t.dep_time).toLocaleString()} → ${new Date(t.arr_time).toLocaleString()}</div>
      <div>Airline: ${t.airline_name}</div>
      <button class="btn-cancel">Cancel this ticket</button>`;
    div.querySelector(".btn-cancel").addEventListener("click", async () => {
      if (!confirm(`Cancel ticket ${t.flight_id} (PNR: ${t.pnr})?`)) return;
      const userId = localStorage.getItem("user_id");
      const body = { user_id: userId, flight_id: t.flight_id, seat_no: t.seat_no };
      const res = await fetch(`${API_BASE}/chat/cancel/`, {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (res.ok) { toast(`Ticket cancelled.`, "success"); addMsg(`Cancelled ${t.flight_id} seat ${t.seat_no}.`); div.remove(); }
      else { toast(data.error || "Cancel failed", "error"); }
    });
    return div;
  }

  async function fetchTickets(){
    const user_id = localStorage.getItem("user_id");
    if(!user_id){ addMsg("Please sign in again."); return; }
    const res = await fetch(`${API_BASE}/chat/my-tickets/?user_id=${encodeURIComponent(user_id)}`);
    const data = await res.json().catch(()=>({tickets:[]}));
    if(!res.ok){ addMsg("Couldn't fetch your tickets."); return; }
    if(!data.tickets || data.tickets.length===0){ addMsg("No active bookings found for your account."); return; }
    addMsg("Select a ticket to cancel:");
    data.tickets.forEach(t => chat.appendChild(createTicketCard(t)));
    chat.scrollTop = chat.scrollHeight;
  }

  // ---------- Policy (RAG) ----------
  async function askPolicy(question){
    const res = await fetch(`${API_BASE}/chat/ask-policy/`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ question })
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok){ addMsg(data.error || "Sorry, I couldn't fetch policy info."); return; }
    addMsg(`<div style="margin-bottom:6px"><b>Answer</b></div>${data.answer || "No answer"}`);
    if (data.sources?.length){
      const srcs = data.sources.map(s => `<li>${s}</li>`).join("");
      addMsg(`<div style="opacity:.85">Sources:</div><ul>${srcs}</ul>`);
    }
  }

  // ---- Policy (RAG) chat flow ----
const policyFlow = {
  active: false,
  step: null,           
  data: { question: "" }
};

async function callPolicyAPI(question){
  const res = await fetch(`${API_BASE}/chat/ask-policy/`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ question })
  });
  const data = await res.json().catch(()=>({}));
  if(!res.ok){
    addMsg(data.error || "Sorry, I couldn't fetch policy info.", "bot");
    return;
  }
  addMsg(`<div style="margin-bottom:6px"><b>Answer</b></div>${data.answer || "No answer"}`, "bot");
  if (data.sources && data.sources.length){
    const srcs = data.sources.map(s => `<li>${s}</li>`).join("");
    addMsg(`<div style="opacity:.85">Sources:</div><ul>${srcs}</ul>`, "bot");
  }
}

function startPolicyFlow(){
  policyFlow.active = true;
  policyFlow.step = "ask";
  policyFlow.data = { question: "" };
  addMsg(
    `What policy would you like to know about? (e.g., <i>baggage allowance</i>, <i>pets in cabin</i>, <i>fare</i>).<br>
     Type <b>exit</b> to cancel.`,
    "bot"
  );
}

function proceedPolicyFlow(userText){
  const val = userText.trim();
  if (val.toLowerCase() === "exit"){
    policyFlow.active = false;
    policyFlow.step = null;
    addMsg("Policy assistant closed.", "bot");
    return;
  }

  switch (policyFlow.step){
    case "ask":
      policyFlow.data.question = val;
      policyFlow.step = "done";
      addMsg("Let me check the policy…", "bot");
      policyFlow.active = false;       
      callPolicyAPI(policyFlow.data.question);
      break;
  }
}


  // ---------- Router ----------
  function handleUserMessage(text){
    addMsg(text, "user");
    const low = text.trim().toLowerCase();

    // in-progress flows
    if (statusInputFlow.active) return proceedStatusInputFlow(text);
    if (seatInputFlow.active)   return proceedSeatInputFlow(text);
    if (policyFlow.active)      return proceedPolicyFlow(text);
    if (statusInputFlow.active) return proceedStatusInputFlow(text);
    if (statusFlow.active) return proceedStatusFlow(text);
    if (policyFlow.active) return proceedPolicyFlow(text);
    if (statusFlow.active) return proceedStatusFlow(text);
    



    // entry points
    if (low.includes("flight status") || low === "status" || low === "flight") {
      startStatusInputFlow();
      return;
    }

    if (low.includes("seat availability") || low.includes("availability") || low === "seat") {
  startSeatInputFlow();
  return;
  }


  const quick = parseFlightFiltersLine(text);
  if (Object.keys(quick).length) {
    addMsg("Checking flight status…", "bot");
    callFlightStatusAPI(quick);
    return;
  }

const quickSeat = parseFlightFiltersLine(text);
if (Object.keys(quickSeat).length && (low.includes("seat") || low.includes("availability"))) {
  addMsg("Searching available seats…", "bot");
  callSeatAPI(quickSeat);
  return;
}


    if (low.includes("seat availability") || low.includes("availability") || low === "seat") { startSeatFlow(); return; }
    if (low.includes("cancel")) { addMsg("Fetching your booked tickets…"); fetchTickets(); return; }
    if (low.includes("policy") || low.includes("baggage") || low.includes("pet") || low.includes("refund")) {
  startPolicyFlow();
  return;
}


    addMsg('Try: <b>Flight Status</b>, <b>Seat Availability</b>, <b>Cancel Trip</b>, or <b>Policy</b>.');
  }

  // ---------- Wire up ----------
  sendBtn.addEventListener("click", () => {
    const txt = input.value.trim(); if (!txt) return;
    input.value = ""; handleUserMessage(txt);
  });
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") sendBtn.click(); });

  addMsg("Hello! How may I assist you today?");
</script>

</body>
</html>