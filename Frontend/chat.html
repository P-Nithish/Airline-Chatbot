<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AirBot • Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="chat-wrap">
    <div class="chat-head">AirBot Assistant</div>
    <div id="chat" class="chat-body"></div>
    <div class="chat-foot">
      <input id="input" placeholder="Type here… (e.g., Cancel Trip, Cancellation Policy)" />
      <button id="send">Send</button>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");

    function toast(msg, type = "info", t = 2500) {
      const cont = document.getElementById("toast-container");
      const el = document.createElement("div");
      el.className = "toast " + (type === "success" ? "success" : type === "error" ? "error" : "info");
      el.textContent = msg;
      cont.appendChild(el);
      setTimeout(() => el.remove(), t);
    }

    function addMsg(text, who = "bot", isHTML = false) {
      const m = document.createElement("div");
      m.className = "msg " + (who === "user" ? "user" : "bot");
      if (isHTML) {
        m.innerHTML = text;
      } else {
        m.textContent = text;
      }
      chat.appendChild(m);
      chat.scrollTop = chat.scrollHeight;
    }

    function createTicketCard(t) {
      const div = document.createElement("div");
      div.className = "ticket";
      div.innerHTML = `
        <h4>${t.flight_id} • ${t.src} → ${t.dst} • Seat ${t.seat_no}</h4>
        <div>${new Date(t.dep_time).toLocaleString()} → ${new Date(t.arr_time).toLocaleString()}</div>
        <div>Airline: ${t.airline_name}</div>
        <button class="btn-cancel">Cancel this ticket</button>
      `;
      div.querySelector(".btn-cancel").addEventListener("click", async () => {
        if (!confirm(`Cancel ticket ${t.flight_id} (PNR: ${t.pnr})?`)) return;
        const userId = localStorage.getItem("user_id");
        const body = { user_id: userId, flight_id: t.flight_id, seat_no: t.seat_no };
        const res = await fetch(`${API_BASE}/chat/cancel/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          toast(`Ticket cancelled. Refund ₹${data.refund_amount}`, "success");
          addMsg(`Cancelled ${t.flight_id} seat ${t.seat_no}. Refund ₹${data.refund_amount} by ${data.refund_date}.`, "bot");
          div.remove();
        } else {
          toast(data.error || "Cancel failed", "error");
        }
      });
      return div;
    }

    async function fetchTickets(userId) {
      const res = await fetch(`${API_BASE}/chat/my-tickets/?user_id=${encodeURIComponent(userId)}`);
      const data = await res.json().catch(() => ({ tickets: [] }));
      if (!res.ok) {
        addMsg("Couldn't fetch your tickets.", "bot");
        return [];
      }
      if (!data.tickets || data.tickets.length === 0) {
        addMsg("No active bookings found for your account.", "bot");
        return [];
      }
      addMsg("Select a ticket to cancel:", "bot");
      data.tickets.forEach(t => chat.appendChild(createTicketCard(t)));
      return data.tickets;
    }

    async function getCancellationPolicy(airline, pnr) {
      const res = await fetch(`${API_BASE}/chat/my-tickets/?user_id=${encodeURIComponent(localStorage.getItem("user_id"))}&pnr=${pnr}`);
      const data = await res.json().catch(() => ({ tickets: [] }));
      const ticket = data.tickets.find(t => t.pnr === pnr);
      if (!ticket) {
        addMsg("Ticket not found.", "bot");
        return;
      }
      const query = `cancellation policy and fees for ${ticket.airline_name}`;
      const response = await fetch(`${API_BASE}/chat/policy/?airline=${ticket.airline_name}&query=${encodeURIComponent(query)}`, {
        method: "GET",
      });
      const policyData = await response.json().catch(() => ({ policy: "Policy not available. Check with the airline." }));
      addMsg(`<div class="policy-details">${policyData.policy}</div>`, "bot", true);
    }

    async function handleUserMessage(text) {
      const userId = localStorage.getItem("user_id");
      if (!userId) {
        addMsg("Please sign in again.", "bot");
        return;
      }

      addMsg(text, "user");
      const low = text.trim().toLowerCase();

      if (low.includes("cancel trip")) {
        addMsg("Fetching your booked tickets…", "bot");
        await fetchTickets(userId);
      } else if (low.includes("cancellation policy")) {
        addMsg("Please provide a PNR to check the cancellation policy.", "bot");
        const pnr = prompt("Enter PNR:");
        if (pnr) await getCancellationPolicy(pnr);
      } else if (low.includes("flight status")) {
        addMsg("Please provide a PNR to check the flight status.", "bot");
        const pnr = prompt("Enter PNR:");
        if (pnr) {
          const res = await fetch(`${API_BASE}/chat/my-tickets/?user_id=${userId}&pnr=${pnr}`);
          const data = await res.json().catch(() => ({ tickets: [] }));
          const ticket = data.tickets.find(t => t.pnr === pnr);
          if (ticket) {
            addMsg(`Flight ${ticket.flight_id} is ${ticket.current_status}, departing ${new Date(ticket.current_departure).toLocaleString()}.`, "bot");
          } else {
            addMsg("Ticket not found.", "bot");
          }
        }
      } else {
        addMsg("Try typing: <b>Cancel Trip</b>, <b>Cancellation Policy</b>, or <b>Flight Status</b>", "bot");
      }
    }

    sendBtn.addEventListener("click", () => {
      const txt = input.value.trim();
      if (!txt) return;
      input.value = "";
      handleUserMessage(txt);
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    // Greeting with current date and time
    const now = new Date();
    addMsg(`Hello! It's 12:52 AM IST, Thursday, October 23, 2025. How may I assist you today?`, "bot");
  </script>
</body>
</html>