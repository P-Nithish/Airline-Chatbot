<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AirBot • Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="chat-wrap">
    <div class="chat-head">AirBot Assistant</div>
    <div id="chat" class="chat-body"></div>
    <div class="chat-foot">
      <input id="input" placeholder="Type here… (e.g., Cancel Trip, Cancellation Policy)" />
      <button id="send">Send</button>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
  const API_BASE = "http://127.0.0.1:8000";
  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");

  const seatFlow = {
    active: false,
    step: null,      
    data: { pnr:"", flight_id:"", src:"", dst:"", airline_name:"" }
  };

  function addMsg(text, who="bot"){
    const m = document.createElement("div");
    m.className = "msg " + (who==="user"?"user":"bot");
    m.innerHTML = text;
    chat.appendChild(m);
    chat.scrollTop = chat.scrollHeight;
  }

  function seatCard(s){
    const d = document.createElement("div");
    d.className = "ticket";
    d.innerHTML = `
      <h4>${s.airline_name || ""} ${s.flight_id || ""} • ${s.src || ""} → ${s.dst || ""}</h4>
      <div>${s.dep_time || ""} → ${s.arr_time || ""}</div>
      <div>Seat: <b>${s.seat_no || "-"}</b> • Status: <b>${s.Seat_status || "-"}</b></div>
      <div>PNR: ${s.pnr || "-"}</div>
    `;
    return d;
  }

  const statusFlow = {
    active: false,
    step: null,   // 'pnr' -> 'flight_id' -> 'src' -> 'dst' -> 'airline_name' -> 'done'
    data: { pnr:"", flight_id:"", src:"", dst:"", airline_name:"" }
  };

  function statusCard(s, source){
    const d = document.createElement("div");
    d.className = "ticket";
    const header = `${s.airline_name || ""} ${s.flight_id || ""}`.trim();
    d.innerHTML = `
      <h4>${header || "Flight"} • ${s.src || ""} → ${s.dst || ""}</h4>
      <div>${s.dep_time || ""} → ${s.arr_time || ""}</div>
      <div>Current: <b>${s.current_status || "Unknown"}</b>
      ${s.current_departure ? ` • Departs at: ${s.current_departure}` : ""}
      ${s.current_arrival ? ` • Arrives at: ${s.current_arrival}` : ""}</div>
      ${s.pnr ? `<div>PNR: ${s.pnr}</div>` : ""}
      ${s.seat_no ? `<div>Seat: ${s.seat_no} ${s.Seat_status ? `(${s.Seat_status})` : ""}</div>` : ""}
      <div style="opacity:.7;margin-top:6px;">Source: ${source}</div>
    `;
    return d;
  }

  async function callFlightStatusAPI(payload){
    const res = await fetch(`${API_BASE}/chat/flight-status/`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok){
      addMsg(data.message || data.error || "Please provide at least one field.", "bot");
      return;
    }

    const booked = (data.from_tickets && data.from_tickets.items) || [];
    const inventory = (data.from_available_tickets && data.from_available_tickets.items) || [];
    const total = (data.from_tickets?.count || 0) + (data.from_available_tickets?.count || 0);

    if (!total){
      addMsg("No matching flights found.", "bot");
      return;
    }

    addMsg(`Found <b>${total}</b> matching record${total>1?"s":""}.`, "bot");

    if (booked.length){
      addMsg("<i>From your booked tickets:</i>", "bot");
      booked.forEach(x => chat.appendChild(statusCard(x, "tickets")));
    }
    if (inventory.length){
      addMsg("<i>From available inventory:</i>", "bot");
      inventory.forEach(x => chat.appendChild(statusCard(x, "available_tickets")));
    }
    chat.scrollTop = chat.scrollHeight;
  }


  async function callSeatAPI(payload){
    const res = await fetch(`${API_BASE}/chat/seat-availability/`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok){
      addMsg(data.message || data.error || "Please provide at least one field.", "bot");
      return;
    }
    if(!data.count){
      addMsg("No matching available seats found.", "bot");
      return;
    }
    addMsg(`Found <b>${data.count}</b> available seat${data.count>1?"s":""}:`, "bot");
    (data.seats || []).forEach(s => chat.appendChild(seatCard(s)));
    chat.scrollTop = chat.scrollHeight;
  }

    const API_BASE = "http://127.0.0.1:8000";
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");

    function toast(msg, type = "info", t = 2500) {
      const cont = document.getElementById("toast-container");
      const el = document.createElement("div");
      el.className = "toast " + (type === "success" ? "success" : type === "error" ? "error" : "info");
      el.textContent = msg;
      cont.appendChild(el);
      setTimeout(() => el.remove(), t);
    }

    function addMsg(text, who = "bot", isHTML = false) {
      const m = document.createElement("div");
      m.className = "msg " + (who === "user" ? "user" : "bot");
      if (isHTML) {
        m.innerHTML = text;
      } else {
        m.textContent = text;
      }
      chat.appendChild(m);
      chat.scrollTop = chat.scrollHeight;
    }

      function startStatusFlow(){
    statusFlow.active = true;
    statusFlow.step = "pnr";
    statusFlow.data = { pnr:"", flight_id:"", src:"", dst:"", airline_name:"" };
    addMsg(`To check flight status, you can provide any of:<br>
      <code>{ "pnr": &lt;string&gt;, "flight_id": &lt;string&gt;, "src": &lt;string&gt;, "dst": &lt;string&gt;, "airline_name": &lt;string&gt; }</code><br>
      I’ll ask one by one — type your reply or <b>skip</b>.`, "bot");
    addMsg("PNR? (e.g., RWQ248) • or <b>skip</b>", "bot");
  }

  function proceedStatusFlow(userText){
    const val = userText.trim();
    const lower = val.toLowerCase();

    if (lower === "exit"){
      statusFlow.active = false;
      statusFlow.step = null;
      addMsg("Flight status flow cancelled.", "bot");
      return;
    }

    switch(statusFlow.step){
      case "pnr":
        if (lower !== "skip") statusFlow.data.pnr = val.toUpperCase();
        statusFlow.step = "flight_id";
        addMsg("Flight ID? (e.g., LH0109) • or <b>skip</b>", "bot");
        break;

      case "flight_id":
        if (lower !== "skip") statusFlow.data.flight_id = val.toUpperCase();
        statusFlow.step = "src";
        addMsg("Source airport (IATA)? (e.g., ATL) • or <b>skip</b>", "bot");
        break;

      case "src":
        if (lower !== "skip") statusFlow.data.src = val.toUpperCase();
        statusFlow.step = "dst";
        addMsg("Destination airport (IATA)? (e.g., MIA) • or <b>skip</b>", "bot");
        break;

      case "dst":
        if (lower !== "skip") statusFlow.data.dst = val.toUpperCase();
        statusFlow.step = "airline_name";
        addMsg("Airline name? (e.g., Lufthansa) • or <b>skip</b>", "bot");
        break;

      case "airline_name":
        if (lower !== "skip") statusFlow.data.airline_name = val;
        statusFlow.step = "done";
        const payload = {};
        Object.entries(statusFlow.data).forEach(([k,v]) => { if (v) payload[k]=v; });

        if (Object.keys(payload).length === 0){
          addMsg("Please provide at least one field. Type <b>Flight Status</b> to restart.", "bot");
          statusFlow.active = false;
          statusFlow.step = null;
          return;
        }

        addMsg("Checking flight status…", "bot");
        statusFlow.active = false;
        statusFlow.step = null;
        callFlightStatusAPI(payload);
        break;
    }
  }

    function handleUserMessage(text){
    addMsg(text, "user");
    const low = text.trim().toLowerCase();

    if (statusFlow.active) return proceedStatusFlow(text);
    if (seatFlow.active)   return proceedSeatFlow(text); 

    if (low.includes("flight status") || low === "status" || low === "flight") {
      startStatusFlow();
      return;
    }

    if (low.includes("seat availability") || low.includes("availability") || low === "seat") {
      startSeatFlow();  
      return;
    }

    if (low.includes("cancel")) {
      addMsg("Fetching your booked tickets…", "bot");
      fetchTickets();
      return;
    }

    addMsg('Try: <b>Flight Status</b>, <b>Seat Availability</b>, or <b>Cancel Trip</b>.', "bot");
  }



    function createTicketCard(t) {
      const div = document.createElement("div");
      div.className = "ticket";
      div.innerHTML = `
        <h4>${t.flight_id} • ${t.src} → ${t.dst} • Seat ${t.seat_no}</h4>
        <div>${new Date(t.dep_time).toLocaleString()} → ${new Date(t.arr_time).toLocaleString()}</div>
        <div>Airline: ${t.airline_name}</div>
        <button class="btn-cancel">Cancel this ticket</button>
      `;
      div.querySelector(".btn-cancel").addEventListener("click", async () => {
        if (!confirm(`Cancel ticket ${t.flight_id} (PNR: ${t.pnr})?`)) return;
        const userId = localStorage.getItem("user_id");
        const body = { user_id: userId, flight_id: t.flight_id, seat_no: t.seat_no };
        const res = await fetch(`${API_BASE}/chat/cancel/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          toast(`Ticket cancelled. Refund ₹${data.refund_amount}`, "success");
          addMsg(`Cancelled ${t.flight_id} seat ${t.seat_no}. Refund ₹${data.refund_amount} by ${data.refund_date}.`, "bot");
          div.remove();
        } else {
          toast(data.error || "Cancel failed", "error");
        }
      });
      return div;
    }

    async function fetchTickets(userId) {
      const res = await fetch(`${API_BASE}/chat/my-tickets/?user_id=${encodeURIComponent(userId)}`);
      const data = await res.json().catch(() => ({ tickets: [] }));
      if (!res.ok) {
        addMsg("Couldn't fetch your tickets.", "bot");
        return [];
      }
      if (!data.tickets || data.tickets.length === 0) {
        addMsg("No active bookings found for your account.", "bot");
        return [];
      }
      addMsg("Select a ticket to cancel:", "bot");
      data.tickets.forEach(t => chat.appendChild(createTicketCard(t)));
      return data.tickets;
    }

    async function getCancellationPolicy(airline, pnr) {
      const res = await fetch(`${API_BASE}/chat/my-tickets/?user_id=${encodeURIComponent(localStorage.getItem("user_id"))}&pnr=${pnr}`);
      const data = await res.json().catch(() => ({ tickets: [] }));
      const ticket = data.tickets.find(t => t.pnr === pnr);
      if (!ticket) {
        addMsg("Ticket not found.", "bot");
        return;
      }
      const query = `cancellation policy and fees for ${ticket.airline_name}`;
      const response = await fetch(`${API_BASE}/chat/policy/?airline=${ticket.airline_name}&query=${encodeURIComponent(query)}`, {
        method: "GET",
      });
      const policyData = await response.json().catch(() => ({ policy: "Policy not available. Check with the airline." }));
      addMsg(`<div class="policy-details">${policyData.policy}</div>`, "bot", true);
    }

    async function handleUserMessage(text) {
      const userId = localStorage.getItem("user_id");
      if (!userId) {
        addMsg("Please sign in again.", "bot");
        return;
      }

      addMsg(text, "user");
      const low = text.trim().toLowerCase();

      if (low.includes("cancel trip")) {
        addMsg("Fetching your booked tickets…", "bot");
        await fetchTickets(userId);
      } else if (low.includes("cancellation policy")) {
        addMsg("Please provide a PNR to check the cancellation policy.", "bot");
        const pnr = prompt("Enter PNR:");
        if (pnr) await getCancellationPolicy(pnr);
      } else if (low.includes("flight status")) {
        addMsg("Please provide a PNR to check the flight status.", "bot");
        const pnr = prompt("Enter PNR:");
        if (pnr) {
          const res = await fetch(`${API_BASE}/chat/my-tickets/?user_id=${userId}&pnr=${pnr}`);
          const data = await res.json().catch(() => ({ tickets: [] }));
          const ticket = data.tickets.find(t => t.pnr === pnr);
          if (ticket) {
            addMsg(`Flight ${ticket.flight_id} is ${ticket.current_status}, departing ${new Date(ticket.current_departure).toLocaleString()}.`, "bot");
          } else {
            addMsg("Ticket not found.", "bot");
          }
        }
      } else {
        addMsg("Try typing: <b>Cancel Trip</b>, <b>Cancellation Policy</b>, or <b>Flight Status</b>", "bot");
      }
    }

    sendBtn.addEventListener("click", () => {
      const txt = input.value.trim();
      if (!txt) return;
      input.value = "";
      handleUserMessage(txt);
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    addMsg("Hello! How may I assist you today?");

  </script>
</body>
</html>